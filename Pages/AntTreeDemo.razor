@page "/ant-tree-demo"

<PageTitle>Ant Design Tree Demo</PageTitle>

<h3>Ant Design Tree Drag-and-Drop Demo</h3>
<p class="text-muted">
    This example demonstrates using the Ant Design <code>Tree</code> component with
    drag-and-drop enabled. Drag a node to reorder it or nest it under another
    node. Dropping a node directly on top of another will place it in that
    folder.
</p>
<ul>
    <li>Set <code>Draggable="true"</code> to enable dragging.</li>
    <li>The tree automatically highlights valid drop targets and expands collapsed nodes on hover.</li>
    <li>Handle <code>OnDrop</code> to react when a node has been moved.</li>
</ul>

<Tree TItem="AntTreeNode" DataSource="@treeData" Draggable="true"
      KeyExpression="@(n => n.Id)"
      ChildrenExpression="@(n => n.DataItem.Children)"
      TitleExpression="@(n => n.DataItem.Title)"
      OnDrop="HandleDrop" OnDragStart="HandleDragStart" OnDragEnd="HandleDragEnd">
</Tree>

@code {
    private List<AntTreeNode> treeData = new()
    {
        new AntTreeNode
        {
            Id = 1,
            Title = "Parent 1",
            Children = new()
            {
                new AntTreeNode { Id = 2, Title = "Child 1-1" },
                new AntTreeNode { Id = 3, Title = "Child 1-2" }
            }
        },
        new AntTreeNode
        {
            Id = 4,
            Title = "Parent 2"
        }
    };

    private void HandleDrop(TreeEventArgs<AntTreeNode> args)
    {
        if (args.Node == null || args.TargetNode == null)
        {
            return;
        }

        var source = args.Node.DataItem;
        var target = args.TargetNode.DataItem;

        if (source == target)
        {
            return;
        }

        MoveNode(treeData, source, target);
        Console.WriteLine($"Moved '{source.Title}' into '{target.Title}'");
    }

    private static bool MoveNode(List<AntTreeNode> nodes, AntTreeNode source, AntTreeNode target)
    {
        foreach (var node in nodes)
        {
            if (node.Children.Remove(source))
            {
                target.Children.Add(source);
                return true;
            }

            if (MoveNode(node.Children, source, target))
            {
                return true;
            }
        }

        return false;
    }

    private void HandleDragStart(TreeEventArgs<AntTreeNode> args)
    {
        Console.WriteLine($"Dragging '{args.Node.DataItem.Title}'");
    }

    private void HandleDragEnd(TreeEventArgs<AntTreeNode> args)
    {
        Console.WriteLine($"Finished dragging '{args.Node.DataItem.Title}'");
    }

    public class AntTreeNode
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public List<AntTreeNode> Children { get; set; } = new();
    }
}
