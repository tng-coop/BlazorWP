@page "/edit-demo"
@using TinyMCE.Blazor

<PageTitle>Edit Demo</PageTitle>

<h1>Edit Demo</h1>

<div class="mb-3">
    <button class="btn btn-primary me-1" @onclick="() => SelectDoc(Doc.A)">Document A</button>
    <button class="btn btn-primary me-1" @onclick="() => SelectDoc(Doc.B)">Document B</button>
    <button class="btn btn-primary" @onclick="() => SelectDoc(Doc.C)">Document C</button>
</div>

<div class="mb-2 d-flex">
    <div class="me-2"><span class="led @(initLed ? "flash" : null)"></span> Init</div>
    <div class="me-2"><span class="led @(focusLed ? "flash" : null)"></span> Focus</div>
    <div class="me-2"><span class="led @(blurLed ? "flash" : null)"></span> Blur</div>
    <div class="me-2"><span class="led @(dirtyLed ? "flash" : null)"></span> Dirty</div>
</div>

<TinyMCEEditor @ref="editor"
        OnInit="OnEditorInit"
        Focused="OnEditorFocused"
        ContentBlurred="OnEditorBlurred"
        FirstChange="OnEditorDirty" />

<div class="row mt-3">
    <div class="col">
        <label>Document A</label>
        <textarea class="form-control" rows="5" readonly @bind="docA"></textarea>
    </div>
    <div class="col">
        <label>Document B</label>
        <textarea class="form-control" rows="5" readonly @bind="docB"></textarea>
    </div>
    <div class="col">
        <label>Document C</label>
        <textarea class="form-control" rows="5" readonly @bind="docC"></textarea>
    </div>
</div>

@code {
    private enum Doc { A, B, C }
    private Doc currentDoc = Doc.A;

    private string currentText = string.Empty;
    private string docA = string.Empty;
    private string docB = string.Empty;
    private string docC = string.Empty;

    protected override void OnInitialized()
    {
        currentText = docA;
    }

    private async Task SelectDoc(Doc doc)
    {
        SaveCurrent();
        currentDoc = doc;
        currentText = GetCurrent();
        if (editor != null)
        {
            await editor.SetContentAsync(currentText);
        }
    }

    private void SaveCurrent()
    {
        switch (currentDoc)
        {
            case Doc.A:
                docA = currentText;
                break;
            case Doc.B:
                docB = currentText;
                break;
            case Doc.C:
                docC = currentText;
                break;
        }
    }

    private string GetCurrent() => currentDoc switch
    {
        Doc.A => docA,
        Doc.B => docB,
        Doc.C => docC,
        _ => string.Empty
    };

    private TinyMCEEditor? editor;

    private bool initLed;
    private bool focusLed;
    private bool blurLed;
    private bool dirtyLed;

    private async Task OnEditorInit()
    {
        await FlashAsync(() => initLed = true, () => initLed = false);
        if (editor != null)
        {
            await editor.SetContentAsync(currentText);
        }
    }

    private Task OnEditorFocused()
        => FlashAsync(() => focusLed = true, () => focusLed = false);

    private async Task OnEditorBlurred(string html)
    {
        currentText = html;
        SaveCurrent();
        await FlashAsync(() => blurLed = true, () => blurLed = false);
    }

    private Task OnEditorDirty()
        => FlashAsync(() => dirtyLed = true, () => dirtyLed = false);

    private async Task FlashAsync(Action setOn, Action setOff)
    {
        setOn();
        await InvokeAsync(StateHasChanged);
        await Task.Delay(500);
        setOff();
        await InvokeAsync(StateHasChanged);
    }
}
