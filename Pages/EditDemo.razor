
@page "/edit-demo"
@using TinyMCE.Blazor
@inject IJSRuntime JS

<PageTitle>Edit Demo</PageTitle>

<h1>Edit Demo</h1>

<div class="mb-3">
  <button class="btn btn-primary me-1" @onclick="() => SelectDoc(Doc.A)">Document A</button>
  <button class="btn btn-primary me-1" @onclick="() => SelectDoc(Doc.B)">Document B</button>
  <button class="btn btn-primary"      @onclick="() => SelectDoc(Doc.C)">Document C</button>
</div>

<Editor
  Id="demoEditor"
  ScriptSrc="libman/tinymce/tinymce.min.js"
  LicenseKey="gpl"
  JsConfSrc="myTinyMceConfig"
  @bind-Value="currentText"
  @bind-Value:after="OnContentChanged" />

<div class="row mt-3">
  <div class="col">
    <label>Document A</label>
    <textarea class="form-control" rows="5" readonly @bind="docA"></textarea>
  </div>
  <div class="col">
    <label>Document B</label>
    <textarea class="form-control" rows="5" readonly @bind="docB"></textarea>
  </div>
  <div class="col">
    <label>Document C</label>
    <textarea class="form-control" rows="5" readonly @bind="docC"></textarea>
  </div>
</div>

<div class="row mt-1">
  <div class="col">
    <label>Events</label>
    <textarea class="form-control" rows="5" readonly>@eventLogText</textarea>
  </div>
</div>

@code {
  private enum Doc { A, B, C }
  private Doc currentDoc = Doc.A;

  private string currentText = string.Empty;
  private string docA = string.Empty;
  private string docB = string.Empty;
  private string docC = string.Empty;

  // capture all events
  private List<string> eventLog = new();
  private string eventLogText => string.Join("\n", eventLog);

  protected override void OnInitialized() {
    currentText = docA;
  }

  private void SelectDoc(Doc doc) {
    SaveCurrent();
    currentDoc = doc;
    currentText = GetCurrent();
  }

  private void SaveCurrent() {
    switch (currentDoc) {
      case Doc.A: docA = currentText; break;
      case Doc.B: docB = currentText; break;
      case Doc.C: docC = currentText; break;
    }
  }

  private string GetCurrent() => currentDoc switch {
    Doc.A => docA,
    Doc.B => docB,
    Doc.C => docC,
    _ => string.Empty
  };

  private void OnContentChanged() {
    SaveCurrent();
  }

  protected override async Task OnAfterRenderAsync(bool firstRender) {
    if (firstRender) {
      var module = await JS.InvokeAsync<IJSObjectReference>(
        "import", "./js/tinyMceHelper.js");
      await module.InvokeVoidAsync(
        "registerDotNetHelper",
        DotNetObjectReference.Create(this)
      );
    }
  }

  [JSInvokable]
  public Task LogEvent(string message) {
    eventLog.Insert(0, ($"{DateTime.Now:HH:mm:ss} {message}"));
    StateHasChanged();
    return Task.CompletedTask;
  }

  [JSInvokable]
  public Task OnEditorChange(string html) => LogEvent($"editorChange: content changed");

  [JSInvokable]
  public Task OnEditorBlur()    => LogEvent("editorBlur: lost focus");

  [JSInvokable]
  public Task OnEditorDirty()   => LogEvent("editorDirty: first change");
}