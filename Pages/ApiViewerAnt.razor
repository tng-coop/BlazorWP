@page "/api-ant"
@using System.Text.Json
@using BlazorWP.Data
@inject TreeState TreeState

<PageTitle>Ant Design API Viewer</PageTitle>

<h1>Ant Design API Viewer</h1>

@if (loading)
{
    <p><em>Loading...</em></p>
}
else if (error != null)
{
    <p class="text-danger">@error</p>
}
    else if (TreeState.Nodes != null)
    {
        <Tree TItem="AntJsonNode"
              DataSource="@TreeState.Nodes"
              KeyExpression="n => n.Id"
              ChildrenExpression="n => n.DataItem.Children"
              TitleExpression="n => n.DataItem.Title"
              ExpandedKeys="TreeState.ExpandedKeys.ToArray()"
              SelectedKeys="new[] { TreeState.SelectedKey }"
              ExpandedKeysChanged="OnExpand"
              SelectedKeysChanged="OnSelect"></Tree>
    }
else if (formattedJson != null)
{
    <pre class="json-view">@formattedJson</pre>
}
else
{
    <p>No WordPress endpoint verified. Visit <NavLink href="/">Home</NavLink> first.</p>
}

@code {
    private string? formattedJson;
    private string? error;
    private bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await TreeState.EnsureLoadedAsync();
            formattedJson = TreeState.Nodes != null
                ? JsonSerializer.Serialize(TreeState.Nodes, new JsonSerializerOptions { WriteIndented = true })
                : null;
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            loading = false;
        }
    }

    private void OnExpand(string[] keys)
    {
        TreeState.ExpandedKeys = keys;
    }

    private void OnSelect(string[] keys)
    {
        TreeState.SelectedKey = keys.FirstOrDefault();
    }
}
